{% extends "base.html" %}

{% block title %}Stretch Tracker - AernHome{% endblock %}

{% block extra_head %}
<style>
    .exercise-card {
        user-select: none;
        -webkit-user-select: none;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .exercise-card:active {
        transform: scale(0.97);
    }
    .tick {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 0.375rem;
        border: 2px solid #475569;
        margin: 0 0.2rem;
        transition: all 0.15s ease;
    }
    .tick.done {
        background: #22c55e;
        border-color: #16a34a;
    }
    .streak-badge {
        font-size: 0.75rem;
        padding: 0.15rem 0.5rem;
        border-radius: 9999px;
        background: #1e293b;
        border: 1px solid #334155;
        color: #94a3b8;
    }
    .streak-badge.active {
        background: #14532d;
        border-color: #22c55e;
        color: #4ade80;
    }
    .all-done {
        border-color: #22c55e !important;
    }
</style>
{% endblock %}

{% block content %}
<header class="mb-6">
    <div class="flex items-center justify-between">
        <div>
            <a href="/" class="text-gray-500 hover:text-gray-300 text-sm mb-1 inline-block">&larr; Dashboard</a>
            <h1 class="text-3xl font-bold text-white">Stretch Tracker</h1>
        </div>
        <div class="text-right">
            <div id="today-date" class="text-lg font-medium text-gray-300"></div>
            <div id="streak-display" class="mt-1"></div>
        </div>
    </div>
</header>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="exercises">
    <!-- Exercise cards generated by JS -->
</div>

<div class="flex items-center justify-between">
    <button id="reset-btn" class="text-sm text-gray-500 hover:text-gray-300 transition-colors">Reset today</button>
    <div id="history-summary" class="text-sm text-gray-500"></div>
</div>

<!-- History Section -->
<section class="mt-8">
    <h2 class="text-lg font-semibold text-gray-400 mb-3">Last 7 days</h2>
    <div id="history-grid" class="grid grid-cols-7 gap-2">
        <!-- Filled by JS -->
    </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script>
const EXERCISES = ['Bridge', 'Hip Flexor', 'Hamstring', 'Four-in-Hand'];
const SETS = 3;
const STORAGE_KEY = 'stretch-tracker';

function dateKey(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
}

function todayKey() {
    return dateKey(new Date());
}

function getData() {
    try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    } catch { return {}; }
}

function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function getToday() {
    const data = getData();
    const key = todayKey();
    if (!data[key]) data[key] = {};
    EXERCISES.forEach(ex => {
        if (typeof data[key][ex] !== 'number') data[key][ex] = 0;
    });
    return { data, key, today: data[key] };
}

function tap(exercise) {
    const { data, key, today } = getToday();
    today[exercise] = (today[exercise] + 1) > SETS ? 0 : today[exercise] + 1;
    data[key] = today;
    saveData(data);
    render();
}

function resetToday() {
    const { data, key } = getToday();
    EXERCISES.forEach(ex => data[key][ex] = 0);
    saveData(data);
    render();
}

function getStreak() {
    const data = getData();
    let streak = 0;
    const d = new Date();
    // Check if today is complete â€” if so, count it
    const todayComplete = isComplete(data[todayKey()]);
    if (!todayComplete) {
        // Check if yesterday started a streak
        d.setDate(d.getDate() - 1);
    }
    while (true) {
        const key = dateKey(d);
        if (isComplete(data[key])) {
            streak++;
            d.setDate(d.getDate() - 1);
        } else {
            break;
        }
    }
    return streak;
}

function isComplete(dayData) {
    if (!dayData) return false;
    return EXERCISES.every(ex => dayData[ex] >= SETS);
}

function render() {
    const { today } = getToday();
    const container = document.getElementById('exercises');
    const allDone = EXERCISES.every(ex => today[ex] >= SETS);

    container.innerHTML = EXERCISES.map(ex => {
        const count = today[ex] || 0;
        const done = count >= SETS;
        const ticks = Array.from({length: SETS}, (_, i) =>
            `<span class="tick ${i < count ? 'done' : ''}"></span>`
        ).join('');

        return `
            <div class="exercise-card bg-dark-card border ${done ? 'border-green-500' : 'border-dark-border'} rounded-lg p-5 text-center"
                 onclick="tap('${ex}')">
                <div class="text-base font-medium text-gray-200 mb-3">${ex}</div>
                <div class="flex justify-center">${ticks}</div>
                <div class="text-xs text-gray-500 mt-2">${count}/${SETS}</div>
            </div>
        `;
    }).join('');

    // Date
    const now = new Date();
    document.getElementById('today-date').textContent =
        now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

    // Streak
    const streak = getStreak();
    const streakEl = document.getElementById('streak-display');
    if (streak > 0) {
        streakEl.innerHTML = `<span class="streak-badge active">${streak} day streak</span>`;
    } else {
        streakEl.innerHTML = `<span class="streak-badge">No streak yet</span>`;
    }

    // History summary
    const data = getData();
    const days = Object.keys(data).sort().reverse();
    const completedDays = days.filter(d => isComplete(data[d])).length;
    document.getElementById('history-summary').textContent =
        `${completedDays} day${completedDays !== 1 ? 's' : ''} completed total`;

    // Last 7 days
    renderHistory();
}

function renderHistory() {
    const data = getData();
    const grid = document.getElementById('history-grid');
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        days.push({ key: dateKey(d), date: new Date(d) });
    }

    grid.innerHTML = days.map(({ key, date }) => {
        const dayData = data[key];
        const complete = isComplete(dayData);
        const partial = dayData && EXERCISES.some(ex => dayData[ex] > 0);
        const isToday = key === todayKey();
        const label = date.toLocaleDateString('en-US', { weekday: 'short' });

        let bgClass = 'bg-dark-card border-dark-border';
        if (complete) bgClass = 'bg-green-900/30 border-green-500/50';
        else if (partial) bgClass = 'bg-yellow-900/20 border-yellow-500/30';

        return `
            <div class="rounded-lg border ${bgClass} p-2 text-center ${isToday ? 'ring-1 ring-blue-500' : ''}">
                <div class="text-xs text-gray-500">${label}</div>
                <div class="text-lg mt-1">${complete ? '&#10003;' : partial ? '~' : ''}</div>
            </div>
        `;
    }).join('');
}

// Init
document.getElementById('reset-btn').addEventListener('click', () => {
    if (confirm('Reset today\'s progress?')) resetToday();
});
render();
</script>
{% endblock %}
